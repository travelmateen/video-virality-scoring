name: Deploy UV Project to Hugging Face Spaces

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: hugging_face_env

    steps:
      # 1. Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Setup Python (3.10 for compatibility with your packages)
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. Install system dependencies
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            git-lfs \
            ffmpeg \
            libsm6 \
            libxext6 \
            libxrender1 \
            libgl1 \
            cmake \
            rsync
          git lfs install

      # 4. Install Python dependencies
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install --no-cache-dir "huggingface-hub>=0.30" hf-transfer>=0.1.4

      # 5. Configure git for Hugging Face
      - name: Configure Git User
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 6. Deploy to Hugging Face Space
      - name: Deploy to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          # Store credentials securely
          echo "https://$HF_USERNAME:$HF_TOKEN@huggingface.co" > ~/.git-credentials
          git config --global credential.helper store

          # Clone the space repository
          git clone https://huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME repo

          # Copy files to the repo directory (exclude unnecessary files)
          rsync -av --exclude={'.git','repo','.github','__pycache__','*.pyc','data/raw/*','data/processed/*','data/interim/*'} ./ repo/

          # Commit and push
          cd repo
          git add .
          git commit -m "Automated UV deployment" || echo "No changes to commit"
          git push https://huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME main

      # 7. Cleanup credentials
      - name: Cleanup Credentials
        if: always()
        run: |
          rm -f ~/.git-credentials
